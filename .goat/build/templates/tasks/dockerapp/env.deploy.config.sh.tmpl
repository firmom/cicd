{{- define "dockerapp.env_deploy_config_sh" -}}

{{- $ctx := .ctx -}}
{{- $env := .env -}}
{{- $branch := .branch -}}
{{- $port := .port -}}
{{- $host := .host -}}
{{- $cert := .cert -}}
{{- $name := (index $ctx.Data (print $ctx.From ".name")) -}}
{{- $repoHost := (index $ctx.Data (print $ctx.From ".repo.host")) -}}
{{- $repo := (index $ctx.Data (print $ctx.From ".repo.path")) -}}
{{- $type := (index $ctx.Data (print $ctx.From ".type")) -}}
{{- $image := (index $ctx.Data (print $ctx.From ".docker.image")) -}}
{{- $prodHost := (index $ctx.Data (print $ctx.From ".prod.host")) -}}

#!/bin/sh
set -e

REPO="$1"
TAG="$2"
IMAGE="$3"
DEST_DIR_PATH="/data/deploy/$REPO-$TAG"
DEST_FILE_PATH="$DEST_DIR_PATH/docker-compose.yaml"

mkdir -p $DEST_DIR_PATH

# Add config file
cat > $DEST_FILE_PATH << EndOfMessage
version: '3.4'

services:
  main:
    image: $IMAGE
    environment:
      - "TZ=Europe/Warsaw"
      - "MODE=HTTPS"
    restart: always
    volumes:
      - "/dockerdata/certs/{{$cert}}:/certs"
    ports:
      - {{$port}}:443

EndOfMessage


{{- end -}}
